import java.awt.*;
import java.sql.*;
import java.util.HashMap;
import java.util.Map;

import javax.swing.*;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import java.time.LocalDate;
import java.time.LocalDateTime;

public class Employee {

	private JFrame frmEmployeeManagement;
	private String name, surname1, surname2, id, store;
	public static String mail;
	private String country, city, address, zip_code;

	/**
	 * Launch the application.
	 */
	public static void main(String[] args) {
		EventQueue.invokeLater(new Runnable() {
			public void run() {
				try {
					Employee window = new Employee();
					window.frmEmployeeManagement.setVisible(true);
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		});
	}

	/**
	 * Create the application.
	 */
	public Employee() {
		initialize();
	}

	/**
	 * Initialize the contents of the frame.
	 */
	private void initialize() {
		
		
		frmEmployeeManagement = new JFrame();
	    frmEmployeeManagement.setTitle("Employee Management");
	    frmEmployeeManagement.setIconImage(new ImageIcon("H:\\Mi unidad\\JAVA\\img\\icon2.png").getImage());
	    frmEmployeeManagement.setBounds(100, 100, 450, 300);
	    frmEmployeeManagement.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
	    frmEmployeeManagement.getContentPane().setLayout(null);

	    JMenuBar menuBar = new JMenuBar();
	    frmEmployeeManagement.setJMenuBar(menuBar);

	    JMenu mnAnadir = new JMenu("Añadir...");
	    menuBar.add(mnAnadir);

	    JMenuItem mntmCustomer = new JMenuItem("Cliente");
	    mntmCustomer.addActionListener(new ActionListener() {
	    	public void actionPerformed(ActionEvent e) {
	    		addCliente();
	    	}
	    });
	    mnAnadir.add(mntmCustomer);
	    JMenuItem mntmEmployee = new JMenuItem("Empleado");
	    mntmEmployee.addActionListener(new ActionListener() {
	    	public void actionPerformed(ActionEvent e) {
	    		addEmpleado();
	    	}
	    });
	    mnAnadir.add(mntmEmployee);
	    JMenuItem mntmOrder = new JMenuItem("Pedido");
	    mntmOrder.addActionListener(new ActionListener() {
	    	public void actionPerformed(ActionEvent e) {
	    		addPedido();
	    	}
	    });
	    mnAnadir.add(mntmOrder);
	    JMenuItem mntmStore = new JMenuItem("Tienda");
	    mntmStore.addActionListener(new ActionListener() {
	    	public void actionPerformed(ActionEvent e) {
	    		addTienda();
	    	}
	    });
	    mnAnadir.add(mntmStore);
	    JMenuItem mntmProduct = new JMenuItem("Producto");
	    mntmProduct.addActionListener(new ActionListener() {
	    	public void actionPerformed(ActionEvent e) {
	    		addProducto();
	    	}
	    });
	    mnAnadir.add(mntmProduct);

	    JMenu mnOpciones = new JMenu("Opciones");
	    menuBar.add(mnOpciones);

	    JMenuItem mntmCerrar = new JMenuItem("Cerrar Sesión");
	    mntmCerrar.addActionListener(new ActionListener() {
	    	public void actionPerformed(ActionEvent e) {
	    		frmEmployeeManagement.dispose();
	    		Login log = new Login();
	    		log.main(null);
	    	}
	    });
	    
	    JMenuItem mntmInformacion = new JMenuItem("Información");
	    mntmInformacion.addActionListener(new ActionListener() {
	    	public void actionPerformed(ActionEvent e) {
	    		mostrarInformacion();
	    	}
	    });
	    mnOpciones.add(mntmInformacion);
	    mnOpciones.add(mntmCerrar);
	    
	    JMenu mnEditar = new JMenu("Editar...");
	    menuBar.add(mnEditar);
	    
	    JMenuItem mntmContrasena = new JMenuItem("Tu contraseña");
	    mnEditar.add(mntmContrasena);
		
		//Poder modificar la informacion personal tanto de clientes como empleados
		
		//Poder editar estado de pedidos
	    
	}
	
	private void addCliente() {
		JTextField nombreField = new JTextField();
        JTextField ap1Field = new JTextField();
        JTextField ap2Field = new JTextField();
        JTextField mailField = new JTextField();
        JTextField passwField = new JTextField();

        JPanel panel = new JPanel(new GridLayout(0, 1));
        panel.add(new JLabel("Nombre:"));
        panel.add(nombreField);
        panel.add(new JLabel("Apellido 1:"));
        panel.add(ap1Field);
        panel.add(new JLabel("Apellido2:"));
        panel.add(ap2Field);
        panel.add(new JLabel("Email:"));
        panel.add(mailField);
        panel.add(new JLabel("Contraseña:"));
        panel.add(passwField);

        int result = JOptionPane.showConfirmDialog(null, panel, "Añadir Producto",
                JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

        if (result == JOptionPane.OK_OPTION) {
            String nombre = nombreField.getText();
            String ap1 = ap1Field.getText();
            String ap2 = ap2Field.getText();
            String mail = mailField.getText();
            String passw = passwField.getText();

            try (Connection conn = DBConnection.getConnection()) {
                String sql = "INSERT INTO clientes (nombre, apellido1, apellido2, mail, passw) VALUES (?, ?, ?, ?, ?)";
                PreparedStatement stmt = conn.prepareStatement(sql);
                stmt.setString(1, nombre);
                stmt.setString(2, ap1);
                stmt.setString(3, ap2);
                stmt.setString(4, mail);
                stmt.setString(5, passw);

                int rowsInserted = stmt.executeUpdate();
                if (rowsInserted > 0) {
                    JOptionPane.showMessageDialog(null, "Cliente añadido exitosamente.");
                }
            } catch (SQLException ex) {
                ex.printStackTrace();
                JOptionPane.showMessageDialog(null, "Error al insertar el cliente.", "Error", JOptionPane.ERROR_MESSAGE);
            }
        }
	}
	
	private void addEmpleado() {
		JTextField nombreField = new JTextField();
        JTextField ap1Field = new JTextField();
        JTextField ap2Field = new JTextField();
        JTextField mailField = new JTextField();
        JTextField passwField = new JTextField();
        JComboBox<String> tiendaBox = new JComboBox<>();
        Map<String, String> calleToIdMap = new HashMap<>();

        try (Connection conn = DBConnection.getConnection()) {
            String sqlTiendas = "SELECT id_tienda, calle_tienda FROM tiendas";
            PreparedStatement stmtTiendas = conn.prepareStatement(sqlTiendas);
            ResultSet rs = stmtTiendas.executeQuery();

            while (rs.next()) {
                String idTienda = rs.getString("id_tienda");
                String calle = rs.getString("calle_tienda");
                tiendaBox.addItem(calle);
                calleToIdMap.put(calle, idTienda);
            }

        } catch (SQLException e) {
            e.printStackTrace();
            JOptionPane.showMessageDialog(null, "Error al cargar los empleados", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        JPanel panel = new JPanel(new GridLayout(0, 1));
        panel.add(new JLabel("Nombre:"));
        panel.add(nombreField);
        panel.add(new JLabel("Apellido 1:"));
        panel.add(ap1Field);
        panel.add(new JLabel("Apellido2:"));
        panel.add(ap2Field);
        panel.add(new JLabel("Email:"));
        panel.add(mailField);
        panel.add(new JLabel("Contraseña:"));
        panel.add(passwField);
        panel.add(new JLabel("Tienda:"));
        panel.add(tiendaBox);

        int result = JOptionPane.showConfirmDialog(null, panel, "Añadir Empleado",
                JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

        if (result == JOptionPane.OK_OPTION) {
            String nombre = nombreField.getText();
            String ap1 = ap1Field.getText();
            String ap2 = ap2Field.getText();
            String mail = mailField.getText();
            String passw = passwField.getText();
            String calleSeleccionada = (String) tiendaBox.getSelectedItem();
            String idTienda = calleToIdMap.get(calleSeleccionada);

            try (Connection conn = DBConnection.getConnection()) {
                String sql = "INSERT INTO empleados (nombre_empleado, apellido1_empleado, apellido2_empleado, mail_empleado, passw_empleado, fk_tienda) VALUES (?, ?, ?, ?, ?, ?)";
                PreparedStatement stmt = conn.prepareStatement(sql);
                stmt.setString(1, nombre);
                stmt.setString(2, ap1);
                stmt.setString(3, ap2);
                stmt.setString(4, mail);
                stmt.setString(5, passw);
                stmt.setString(6, idTienda);

                int rowsInserted = stmt.executeUpdate();
                if (rowsInserted > 0) {
                    JOptionPane.showMessageDialog(null, "Empleado añadido exitosamente.");
                }
            } catch (SQLException ex) {
                ex.printStackTrace();
                JOptionPane.showMessageDialog(null, "Error al insertar el empleado.", "Error", JOptionPane.ERROR_MESSAGE);
            }
        }
	}
	
	private void addPedido() {
	    JTextField paisField = new JTextField();
	    JTextField ciudadField = new JTextField();
	    JTextField calleField = new JTextField();
	    JTextField postalField = new JTextField();
	    JTextField idUserField = new JTextField(); 

	    JComboBox<String> tiendaBox = new JComboBox<>();
	    Map<String, String> calleToIdMap = new HashMap<>();

	    try (Connection conn = DBConnection.getConnection()) {
	        String sqlTiendas = "SELECT id_tienda, calle_tienda FROM tiendas";
	        PreparedStatement stmtTiendas = conn.prepareStatement(sqlTiendas);
	        ResultSet rs = stmtTiendas.executeQuery();

	        while (rs.next()) {
	            String idTienda = rs.getString("id_tienda");
	            String calle = rs.getString("calle_tienda");
	            tiendaBox.addItem(calle);
	            calleToIdMap.put(calle, idTienda);
	        }

	    } catch (SQLException e) {
	        e.printStackTrace();
	        JOptionPane.showMessageDialog(null, "Error al cargar las tiendas", "Error", JOptionPane.ERROR_MESSAGE);
	        return;
	    }

	    JPanel panel = new JPanel(new GridLayout(0, 1));
	    panel.add(new JLabel("País:"));
	    panel.add(paisField);
	    panel.add(new JLabel("Ciudad:"));
	    panel.add(ciudadField);
	    panel.add(new JLabel("Calle:"));
	    panel.add(calleField);
	    panel.add(new JLabel("Código Postal:"));
	    panel.add(postalField);
	    panel.add(new JLabel("ID Cliente:"));
	    panel.add(idUserField);
	    panel.add(new JLabel("Tienda:"));
	    panel.add(tiendaBox);

	    int result = JOptionPane.showConfirmDialog(null, panel, "Añadir Pedido",
	            JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

	    if (result == JOptionPane.OK_OPTION) {
	        String pais = paisField.getText();
	        String ciudad = ciudadField.getText();
	        String calle = calleField.getText();
	        String postal = postalField.getText();
	        String idUser = idUserField.getText();

	        String calleSeleccionada = (String) tiendaBox.getSelectedItem();
	        String idTienda = calleToIdMap.get(calleSeleccionada);

	        LocalDateTime now = LocalDateTime.now();
	        Timestamp timestampNow = Timestamp.valueOf(now); 

	        try (Connection conn = DBConnection.getConnection()) {
	            String sql = "INSERT INTO pedidos (fecha_pedido, pais_pedido, ciudad_pedido, calle_pedido, postal_pedido, fk_id_user, fk_tienda) " +
	                         "VALUES (?, ?, ?, ?, ?, ?, ?)";
	            PreparedStatement stmt = conn.prepareStatement(sql);
	            stmt.setTimestamp(1, timestampNow);
	            stmt.setString(2, pais);
	            stmt.setString(3, ciudad);
	            stmt.setString(4, calle);
	            stmt.setString(5, postal);
	            stmt.setInt(6, Integer.parseInt(idUser));
	            stmt.setInt(7, Integer.parseInt(idTienda));

	            int rowsInserted = stmt.executeUpdate();
	            if (rowsInserted > 0) {
	                JOptionPane.showMessageDialog(null, "Pedido añadido exitosamente.");
	            }
	        } catch (SQLException | NumberFormatException ex) {
	            ex.printStackTrace();
	            JOptionPane.showMessageDialog(null, "Error al insertar el pedido. Verifica los datos.", "Error", JOptionPane.ERROR_MESSAGE);
	        }
	    }
	}
	
	private void addTienda() {
	    JComboBox<String> paisBox = new JComboBox<>(new String[]{"España", "Portugal"});
	    JComboBox<String> ciudadBox = new JComboBox<>();

	    ciudadBox.setModel(new DefaultComboBoxModel<>(new String[]{"Madrid", "Barcelona", "Valencia"}));

	    JTextField calleField = new JTextField();
	    JTextField postalField = new JTextField();

	    paisBox.addActionListener(new ActionListener() {
	        @Override
	        public void actionPerformed(ActionEvent e) {
	            String selectedPais = (String) paisBox.getSelectedItem();
	            if (selectedPais.equals("España")) {
	                ciudadBox.setModel(new DefaultComboBoxModel<>(new String[]{"Madrid", "Barcelona", "Valencia"}));
	            } else if (selectedPais.equals("Portugal")) {
	                ciudadBox.setModel(new DefaultComboBoxModel<>(new String[]{"Oporto", "Lisboa"}));
	            }
	        }
	    });

	    JPanel panel = new JPanel(new GridLayout(0, 1));
	    panel.add(new JLabel("País:"));
	    panel.add(paisBox);
	    panel.add(new JLabel("Ciudad:"));
	    panel.add(ciudadBox);
	    panel.add(new JLabel("Calle:"));
	    panel.add(calleField);
	    panel.add(new JLabel("Código Postal:"));
	    panel.add(postalField);

	    int result = JOptionPane.showConfirmDialog(null, panel, "Añadir Tienda",
	            JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

	    if (result == JOptionPane.OK_OPTION) {
	        String pais = (String) paisBox.getSelectedItem();
	        String ciudad = (String) ciudadBox.getSelectedItem();
	        String calle = calleField.getText();
	        String codigo = postalField.getText();

	        try (Connection conn = DBConnection.getConnection()) {
	            String sql = "INSERT INTO tiendas (pais_tienda, ciudad_tienda, calle_tienda, postal_tienda) VALUES (?, ?, ?, ?)";
	            PreparedStatement stmt = conn.prepareStatement(sql);
	            stmt.setString(1, pais);
	            stmt.setString(2, ciudad);
	            stmt.setString(3, calle);
	            stmt.setString(4, codigo);

	            int rowsInserted = stmt.executeUpdate();
	            if (rowsInserted > 0) {
	                JOptionPane.showMessageDialog(null, "Tienda añadida exitosamente.");
	            }
	        } catch (SQLException ex) {
	            ex.printStackTrace();
	            JOptionPane.showMessageDialog(null, "Error al insertar la tienda.", "Error", JOptionPane.ERROR_MESSAGE);
	        }
	    }
	}
	
	private void addProducto() {
        JTextField marcaField = new JTextField();
        JTextField modeloField = new JTextField();
        JTextField precioField = new JTextField();
        JTextField stockField = new JTextField();
        JComboBox<String> categoriaBox = new JComboBox<>(new String[]{"Zapatillas", "Sudaderas", "Camisetas"});

        JPanel panel = new JPanel(new GridLayout(0, 1));
        panel.add(new JLabel("Categoria:"));
        panel.add(categoriaBox);
        panel.add(new JLabel("Marca:"));
        panel.add(marcaField);
        panel.add(new JLabel("Modelo:"));
        panel.add(modeloField);
        panel.add(new JLabel("Precio:"));
        panel.add(precioField);
        panel.add(new JLabel("Stock:"));
        panel.add(stockField);

        int result = JOptionPane.showConfirmDialog(null, panel, "Añadir Producto",
                JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

        if (result == JOptionPane.OK_OPTION) {
        	String categoria = (String) categoriaBox.getSelectedItem();
            String marca = marcaField.getText();
            String modelo = modeloField.getText();
            String precioTexto = precioField.getText().replace(',', '.'); //SI ALGUIEN INTRODUCE , ESTO PONE .
            String stockTexto = stockField.getText();

            try {
                double precio = Double.parseDouble(precioTexto);
                int stock = Integer.parseInt(stockTexto);

                try (Connection conn = DBConnection.getConnection()) {
                    String sql = "INSERT INTO productos (marca, modelo, categoria, precio, stock) VALUES (?, ?, ?, ?, ?)";
                    PreparedStatement stmt = conn.prepareStatement(sql);
                    stmt.setString(1, marca);
                    stmt.setString(2, modelo);
                    stmt.setString(3, categoria);
                    stmt.setDouble(4, precio);
                    stmt.setInt(5, stock);

                    int rowsInserted = stmt.executeUpdate();
                    if (rowsInserted > 0) {
                        JOptionPane.showMessageDialog(null, "Producto añadido exitosamente.");
                    }
                } catch (SQLException ex) {
                    ex.printStackTrace();
                    JOptionPane.showMessageDialog(null, "Error al insertar el producto.", "Error", JOptionPane.ERROR_MESSAGE);
                }
            } catch (NumberFormatException ex) {
                JOptionPane.showMessageDialog(null, "Precio o stock no válidos.", "Error", JOptionPane.ERROR_MESSAGE);
            }
        }
    }
	
	private void mostrarInformacion() {
		try (Connection conn = DBConnection.getConnection()) {
			String sqlEmpleado = "SELECT * FROM empleados WHERE mail_empleado = ?";
			PreparedStatement stmtEmpleado = conn.prepareStatement(sqlEmpleado);
			stmtEmpleado.setString(1, mail);
	        
	        ResultSet rsEmpleado = stmtEmpleado.executeQuery();

	        if (rsEmpleado.next()) {
	            name = rsEmpleado.getString("nombre_empleado");
	            surname1 = rsEmpleado.getString("apellido1_empleado");
	            surname2 = rsEmpleado.getString("apellido2_empleado");
	            id = rsEmpleado.getString("id_empleado");
	            store = rsEmpleado.getString("fk_tienda");
	        }
	        
	        //TABLA TIENDA
	        String sqlTienda = "SELECT * FROM tiendas WHERE id_tienda = ?";
			PreparedStatement stmtTienda = conn.prepareStatement(sqlTienda);
			stmtEmpleado.setString(1, store);
	        
	        ResultSet rsTienda = stmtEmpleado.executeQuery();
	        
	        if (rsTienda.next()) {
	        	country = rsTienda.getString("pais_tienda");
	        	city = rsTienda.getString("ciudad_tienda");
	        	address = rsTienda.getString("calle_tienda");
	        	zip_code = rsTienda.getString("postal_tienda");
	        }

	    } catch (SQLException ex) {
	        ex.printStackTrace();
	        JOptionPane.showMessageDialog(null, "Error de conexión a la base de datos", "Error", JOptionPane.ERROR_MESSAGE);
	    }
		
		JPanel panel = new JPanel(new GridLayout(0, 1));
		panel.add(new JLabel("ID: " + id));
		panel.add(new JLabel("Nombre: " + name + " " + surname1 + " " + surname2));
		panel.add(new JLabel("Mail: " + mail));
		panel.add(new JLabel("Tienda: " + (store != null ? store : "")));
		int result = JOptionPane.showConfirmDialog(null, panel, "Añadir Producto",
                JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);
	}
}
